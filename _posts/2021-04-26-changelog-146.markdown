---
layout: post
title: "IntelliJ Rust Changelog #146"
date: 2021-04-26 17:00:00 +0300
---


## New Features

* [#6992] Provide initial experimental support for [custom derive]
  procedural macros. Now the plugin can expand such procedural macro calls and take into account expanded `impl` items
  in type inference and name resolution (other types of items are ignored for now).<br/>
  Note, it’s only an initial implementation,
  so it may work in an unexpected way in some cases. The feature is disabled by default for now. To turn it on, you
  should enable `Use experimental name resolution engine` option in `Preferences | Languages & Frameworks | Rust`
  settings and enable `org.rust.cargo.evaluate.build.scripts` and `org.rust.macros.proc` experimental features
  (see instructions [here][experimental features]).
  Don’t forget to reload a project structure after enabling the corresponding features via `Refresh Cargo Projects`
  action on Cargo tool window. See [tracking issue](https://github.com/intellij-rust/intellij-rust/issues/6908) for
  more details and the current status of procedural macros support

  {% include gif-img-wh.html path="/assets/posts/changelog-146/custom-derive" w="600px" h="300px" %}

* [#7093] Now the plugin takes [Cargo config] into account during evaluation of [`cfg` conditions][cfg].
  Note, it works since Rust 1.52.0 (currently in beta)

  {% include gif-img-wh.html path="/assets/posts/changelog-146/cfg-cargo-config" w="600px" h="300px" %}

* [#6845], [#7115] Provide an intention action that toggles feature state from a `cfg` attribute (by [@Kobzol])

  {% include gif-img-wh.html path="/assets/posts/changelog-146/intention-cargo-feature" w="600px" h="300px" %}
  By the way, we have a [blogpost][cargo features blogpost] about cargo features support

* [#7071] Provide `Share in Playground` intention action to share a selected Rust code on [Rust Playground](https://play.rust-lang.org).

  {% include gif-img.html path="/assets/posts/changelog-146/intention-playground" w="600px" %}
  Previously, this feature was only available as an action in right-click menu.

* Improve [code folding]:

  * [#7111] Support folding for multiline `where` clauses (by [@Stzx])

    {% include gif-img-wh.html path="/assets/posts/changelog-146/fold-where" w="600px" h="300px" %}

  * [#7112] Support folding by default for series of use items (by [@Stzx])<br>
    The option is **enabled** by default.
    You can disable it in `Settings | Editor | General | Code Folding | General | imports`

  * [#7112] Support folding by default for function bodies (by [@Stzx])<br>
    The option is **disabled** by default.
    `imports` (actually use items) and `method bodies` (actually function bodies)
    You can enable it in `Settings | Editor | General | Code Folding | General | method bodies`

* [#6960] Provide an intention action to expand dependency specification in `Cargo.toml`

  {% include gif-img-wh.html path="/assets/posts/changelog-146/intention-expand-dependency" w="600px" h="300px" %}

* [#6837] Provide an intention action to create a struct from an unresolved struct literal (by [@Kobzol])

  {% include gif-img-wh.html path="/assets/posts/changelog-146/intention-struct" w="600px" h="300px" %}

* Improve experimental crate-local index:

  * [#6801] Add `Cargo.toml` inspection that checks crate dependency version requirements that do not match any known crate version (by [@Kobzol])

  * [#6599] Use semantic versioning to improve version sorting in dependency completion

  Note, the corresponding feature is disabled by default for now. To use it, enable
  `org.rust.crates.local.index` experimental feature (see instructions [here][experimental features])

* [#7142] Drop support of `org.rust.cargo.evaluate.build.scripts` experimental feature.
  Use `org.rust.cargo.evaluate.build.scripts` instead if you need to evaluate
  `env!("OUT_DIR")` in your `include!` macro calls

## Fixes

* [#5650] Improve `Use destructuring declaration` intention action: replace usages of destructured variable (by [@Kobzol])

  {% include gif-img-wh.html path="/assets/posts/changelog-146/intention-destructure-decl" w="600px" h="150px" %}

* [#6986] Allow explicitly stating the function return type in `Create function` if the inferred return type was unknown. (by [@Kobzol])

  {% include gif-img-wh.html path="/assets/posts/changelog-146/intention-create-function" w="600px" h="300px" %}

* Name resolution fixes:

  * [#7119] Fix name resolution: correctly resolve qualified attribute proc macro paths (like `#[foo::bar]`)

  * [#7132] Fix name resolution: resolve field shorthand to a local variable in the case of unresolved struct literal

* New name resolution fixes

  * [#7089] Fix name resolution: correctly resolve macros with absolute paths (like `::foo::bar!()`) with new name resolution engine

  * [#7057] Exclude some cfg-disabled items from completion when using new name resolution engine

* `Change Signature` refactoring fixes:

  * [#7081] Fix some false positives in name conflict detection (by [@Kobzol])

  * [#7080] Do not needlessly import default type arguments (by [@Kobzol])

  * [#7076] Correctly place function visibility after attributes (by [@Kobzol])

* [#7108] Fix auto-import: insert correct import in the case of a renamed cargo package

* [#7101] Fix false positive in `Needless lifetimes` inspection when the lifetime is used in where clause. (by [@Kobzol])

* [#5491] Improve built-in formatter: add line break after opening brace in struct blocks (by [@Kobzol])

* [#7131] Fix false-positive proofreading warnings for sentences written in several sequential Rust comments.
  Note, you can enable/disable proofreading in Rust files in `Preferences | Editor | Proofreading | Grammar` settings

* [#7121] Refresh Cargo project automatically when workspace-root `Cargo.toml` file is changed (and saved).
  Previously it was work only for package `Cargo.toml` files.

* [#7079] Fix proc macro expansion if proc macro crate is added as separate cargo project in `Cargo` toolwindow

* [#7072] Place `Show the result of macro expansion` intention lower in the intention list

* [#6013] Don't run inspections on Rust files outside a valid Cargo project

* [#7070] Don't show errors related to Rust edition if we don't known the edition (by [@Stzx])

* [#7004] Fix experimental crate-local index: don't perform code completion and run inspections if the index is not ready

* [#7150] Fix `Can't find process starter` error when running DTrace profiler with CLion 2021.1

* [#6201] Avoid Cargo project duplication in the project model. This fixes some issues related to such duplications

## Internal Improvements

* [#7114] Don't show "Tip of the Day" at startup in internal IDEs (for the plugin developers)

* [#7094] Enable Gradle Build Cache for local builds
  (see [#7094](https://github.com/intellij-rust/intellij-rust/pull/7094) for more details)

* [#6903] Introduce `2021` edition variant in the plugin and adjust the corresponding code

Full set of changes can be found [here](https://github.com/intellij-rust/intellij-rust/milestone/54?closed=1)

[@Kobzol]: https://github.com/Kobzol
[@Stzx]: https://github.com/Stzx
[@abn]: https://github.com/abn

[#7142]: https://github.com/intellij-rust/intellij-rust/pull/7142
[#7112]: https://github.com/intellij-rust/intellij-rust/pull/7112
[#7111]: https://github.com/intellij-rust/intellij-rust/pull/7111
[#7100]: https://github.com/intellij-rust/intellij-rust/pull/7100
[#7093]: https://github.com/intellij-rust/intellij-rust/pull/7093
[#7071]: https://github.com/intellij-rust/intellij-rust/pull/7071
[#6992]: https://github.com/intellij-rust/intellij-rust/pull/6992
[#6986]: https://github.com/intellij-rust/intellij-rust/pull/6986
[#6960]: https://github.com/intellij-rust/intellij-rust/pull/6960
[#6845]: https://github.com/intellij-rust/intellij-rust/pull/6845
[#6837]: https://github.com/intellij-rust/intellij-rust/pull/6837
[#6801]: https://github.com/intellij-rust/intellij-rust/pull/6801
[#6599]: https://github.com/intellij-rust/intellij-rust/pull/6599
[#6013]: https://github.com/intellij-rust/intellij-rust/pull/6013
[#5650]: https://github.com/intellij-rust/intellij-rust/pull/5650
[#5491]: https://github.com/intellij-rust/intellij-rust/pull/5491
[#7150]: https://github.com/intellij-rust/intellij-rust/pull/7150
[#7132]: https://github.com/intellij-rust/intellij-rust/pull/7132
[#7131]: https://github.com/intellij-rust/intellij-rust/pull/7131
[#7121]: https://github.com/intellij-rust/intellij-rust/pull/7121
[#7119]: https://github.com/intellij-rust/intellij-rust/pull/7119
[#7115]: https://github.com/intellij-rust/intellij-rust/pull/7115
[#7108]: https://github.com/intellij-rust/intellij-rust/pull/7108
[#7101]: https://github.com/intellij-rust/intellij-rust/pull/7101
[#7089]: https://github.com/intellij-rust/intellij-rust/pull/7089
[#7081]: https://github.com/intellij-rust/intellij-rust/pull/7081
[#7080]: https://github.com/intellij-rust/intellij-rust/pull/7080
[#7079]: https://github.com/intellij-rust/intellij-rust/pull/7079
[#7076]: https://github.com/intellij-rust/intellij-rust/pull/7076
[#7072]: https://github.com/intellij-rust/intellij-rust/pull/7072
[#7070]: https://github.com/intellij-rust/intellij-rust/pull/7070
[#7057]: https://github.com/intellij-rust/intellij-rust/pull/7057
[#7004]: https://github.com/intellij-rust/intellij-rust/pull/7004
[#6201]: https://github.com/intellij-rust/intellij-rust/pull/6201
[#7114]: https://github.com/intellij-rust/intellij-rust/pull/7114
[#7094]: https://github.com/intellij-rust/intellij-rust/pull/7094
[#7046]: https://github.com/intellij-rust/intellij-rust/pull/7046
[#6903]: https://github.com/intellij-rust/intellij-rust/pull/6903

[custom derive]: https://doc.rust-lang.org/reference/procedural-macros.html#derive-macros
[experimental features]: https://plugins.jetbrains.com/plugin/8182-rust/docs/rust-faq.html#experimental-features
[Cargo config]: https://doc.rust-lang.org/cargo/reference/config.html
[cfg]: https://doc.rust-lang.org/reference/conditional-compilation.html
[cargo features blogpost]: https://blog.jetbrains.com/clion/2020/10/intellij-rust-new-functionality-for-cargo-features/
[code folding]: https://www.jetbrains.com/help/idea/working-with-source-code.html#code_folding
